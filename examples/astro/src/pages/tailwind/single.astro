---
import fs from "node:fs/promises";
import path from "node:path";
import { cx } from "class-variance-authority";
import { imageList, imageListItem } from "@plaiceholder/ui";
import { getPlaiceholder } from "plaiceholder";
import { extractImgSrc } from "@plaiceholder/tailwindcss/utils";
import { config } from "@/config";
import Layout from "@/layouts/Layout.astro";

const title = config.examples.pages.tailwind.title;
const heading = config.examples.variants.single.title;

const getImage = async (plaiceholder: string) => {
  const src = extractImgSrc(plaiceholder);
  const buffer = await fs.readFile(path.join("./public", src));

  const {
    metadata: { height, width },
  } = await getPlaiceholder(buffer);

  return { plaiceholder, img: { src, height, width } };
};

const { plaiceholder, img } = await getImage(
  "plaiceholder-[/assets/images/keila-joa@578.jpg]"
);
---

<Layout variant="example" title={title} heading={heading}>
  <ul role="list" class={imageList({ columns: 2 })}>
    <li class={imageListItem()}>
      <div
        class={cx(
          plaiceholder,
          "absolute",
          "inset-0",
          "w-full",
          "h-full",
          "transform",
          "scale-150",
          "filter",
          "blur-2xl",
          "z-[-1]"
        )}
      >
      </div>
      {
        /**
         * For now, @plaiceholder/tailwindcss needs the image to be in `/public`,
         * which @astrojs/image doesn't support.
         *
         * So we'll use a regular-ol' `<img>` instead:
         */
      }
      <img
        {...img}
        alt="Looking down Keila river, Estonia"
        title="Photo by Joe Bell"
      />
    </li>
  </ul>
</Layout>
